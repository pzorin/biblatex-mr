%% biblatex-mr.sty
%% Copyright 2013-2014 P. Zorin-Kranich
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is P. Zorin-Kranich.
%
% This work consists of the files biblatex-mr.sty and biblatex-dm.cfg

%% This package modifies standard biblatex styles by including the Math Review number
%% Requires the accompanying change to the biblatex data model
%% The option titlelink makes the title point to URL or DOI if present

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{biblatex-mr}[2014/10/22]

\DeclareOption{titlelink}{
\PassOptionsToPackage{doi=false,url=false,isbn=false}{biblatex}% Do not typeset hyperlinks
\AtBeginDocument{% Add hyperlinks to a string
\newbibmacro{string+urldoi}[1]{%
  \iffieldundef{url}{%
    \iffieldundef{doi}{%
        #1%
      }{% if doi defined
        \href{https://doi.org/\thefield{doi}}{#1}%
    }%
  }{% if url defined
    \href{\thefield{url}}{#1}%
  }%
}
\DeclareFieldFormat[article,misc,incollection,book]{title}{\usebibmacro{string+urldoi}{\mkbibquote{#1}}}
}
}
\ProcessOptions\relax
\RequirePackage{biblatex}

%% smart \MR
%% code suggested by Vilmos Prokaj <prokaj@cs.elte.hu>
%% solves the problem when MR is in a format
%%  \MR{MR1037262 (91i:60148)}

%% \woMR ("without MR"): this macro removes the MR prefix if it
%% is present and does not change the argument otherwise
\def\woMR#1{\w@MR#1MR#1MR\relax}%
\def\w@MR#1MR#2MR#3\relax{#2}

%% this creates a mathscinet URL using first part of MR... (...)
\def\MR@URL#1 #2\relax{http://www.ams.org/mathscinet-getitem?mr=#1}

\AtBeginDocument{
\@ifpackageloaded{hyperref}
{
\def\MRnumber#1{\href{\MR@URL#1 \relax}{\nolinkurl{\woMR#1}}}% make a link to mathscinet
}% else
{
\def\MRnumber#1{\texttt{\woMR#1}}% just typeset the MR number without prefix
}
\DeclareFieldFormat{mrnumber}{\mkbibacro{MR}\addcolon\space\MRnumber{#1}}
\newbibmacro*{doi+eprint+url}{%
  \iftoggle{bbx:doi}
    {\printfield{doi}}
    {}%
  \newunit\newblock
  \iftoggle{bbx:eprint}
    {\usebibmacro{eprint}}
    {}%
  \newunit\newblock
  \iftoggle{bbx:url}
    {\usebibmacro{url+urldate}}
    {}%
  \newunit\newblock
  \printfield{mrnumber}}
}